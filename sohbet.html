<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sohbet Odası</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container { width: 95%; max-width: 400px; padding: 30px; background-color: rgba(30, 30, 30, 0.8); border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); text-align: center; backdrop-filter: blur(5px); }
        #login-container h1 { margin-bottom: 25px; font-weight: 600; }
        input { width: 100%; padding: 12px 15px; margin-bottom: 20px; border: 1px solid #444; border-radius: 8px; background-color: #252525; color: #e0e0e0; font-size: 16px; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
        input:focus { border-color: #00bfa5; box-shadow: 0 0 10px rgba(0, 191, 165, 0.3); }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: #00bfa5; color: #ffffff; font-size: 18px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #00a793; }
        #chat-container { display: none; flex-direction: column; width: 95%; max-width: 600px; height: 90vh; max-height: 800px; padding: 10px; }
        #chat-header { padding: 10px 20px; text-align: left; border-bottom: 1px solid #333; }
        #user-count { font-size: 14px; color: #00bfa5; font-weight: 600; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .message .username { font-size: 12px; font-weight: 600; margin-bottom: 4px; opacity: 0.7; }
        .sent { background-color: #00bfa5; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background-color: #363636; color: #e0e0e0; align-self: flex-start; border-bottom-left-radius: 4px; }
        .system { background-color: #4a4a4a; color: #c0c0c0; align-self: center; font-size: 12px; font-style: italic; border-radius: 8px; }
        #message-form { display: flex; padding: 15px 10px 10px 10px; }
        #message-input { flex-grow: 1; margin-right: 10px; }
        #message-form button { width: auto; padding: 12px 20px; }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>
    <div id="login-container" class="container">
        <h1>Sohbete Katıl</h1>
        <input type="text" id="username-input" placeholder="Kullanıcı adını gir..." maxlength="15">
        <button id="join-button">Giriş Yap</button>
    </div>
    <div id="chat-container" class="container">
        <div id="chat-header">
            Sohbet Odası - <span id="user-count">Aktif Kullanıcı: 0</span>
        </div>
        <div id="messages"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Mesajını yaz..." autocomplete="off">
            <button type="submit">Gönder</button>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase config anahtarın buraya eklendi.
        const firebaseConfig = {
          apiKey: "AIzaSyC18exQhvv4o-iKR7XnX77-alPhZ2v7MWg",
          authDomain: "sohbetbotu-8dc68.firebaseapp.com",
          projectId: "sohbetbotu-8dc68",
          storageBucket: "sohbetbotu-8dc68.appspot.com",
          messagingSenderId: "820321166963",
          appId: "1:820321166963:web:be360711c5be7d99beec06",
          measurementId: "G-PH0DHXD7JG"
        };

        // Firebase'i Başlat
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Kar Yağma Efekti (Değişiklik yok)
        const canvas = document.getElementById('snow-canvas'); const ctx = canvas.getContext('2d'); canvas.width = window.innerWidth; canvas.height = window.innerHeight; let snowflakes = []; function createSnowflakes() { const count = 150; for (let i = 0; i < count; i++) { snowflakes.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 2.5 + 1, speed: Math.random() * 1 + 0.5, opacity: Math.random() * 0.5 + 0.5 }); } } function drawSnowflakes() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "rgba(255, 255, 255, 0.8)"; snowflakes.forEach(flake => { ctx.beginPath(); ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2); ctx.globalAlpha = flake.opacity; ctx.fill(); }); } function updateSnowflakes() { snowflakes.forEach(flake => { flake.y += flake.speed; if (flake.y > canvas.height) { flake.x = Math.random() * canvas.width; flake.y = -5; } }); } function animateSnow() { drawSnowflakes(); updateSnowflakes(); requestAnimationFrame(animateSnow); } createSnowflakes(); animateSnow(); window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; snowflakes = []; createSnowflakes(); });

        // Sohbet Uygulaması Kodları
        const loginContainer = document.getElementById('login-container');
        const chatContainer = document.getElementById('chat-container');
        const joinButton = document.getElementById('join-button');
        const usernameInput = document.getElementById('username-input');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');
        const userCountElement = document.getElementById('user-count');
        
        let username = '';
        const presenceCollection = db.collection("presence");

        // Giriş Butonuna Tıklanınca
        joinButton.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if (name) {
                username = name;
                loginContainer.style.display = 'none';
                chatContainer.style.display = 'flex';

                // Kullanıcıyı aktif olarak işaretle
                presenceCollection.doc(username).set({ online: true, joinedAt: firebase.firestore.FieldValue.serverTimestamp() })
                    .then(() => {
                        console.log(`${username} aktif olarak işaretlendi.`);
                        // Hoş geldin ve sunucu durum mesajını göster
                        addMessage('Sistem', `Hoş geldin ${username}! Sunucuya başarıyla bağlanıldı.`, 'system');
                    });
                
                listenForMessages();
                listenForPresence();
            }
        });

        // Sayfadan ayrılırken kullanıcıyı sil
        window.addEventListener('beforeunload', () => {
            if (username) {
                presenceCollection.doc(username).delete();
            }
        });
        
        usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); joinButton.click(); } });
        
        // Mesaj Gönderme Formu
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText) {
                db.collection("messages").add({
                    text: messageText,
                    sender: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    messageInput.value = '';
                }).catch(err => console.error("Mesaj gönderilemedi", err));
            }
        });

        // Aktif Kullanıcıları Dinleme
        function listenForPresence() {
            presenceCollection.onSnapshot((snapshot) => {
                const count = snapshot.size;
                userCountElement.innerText = `Aktif Kullanıcı: ${count}`;
            });
        }

        // Mesajları Dinleme
        function listenForMessages() {
            db.collection("messages").orderBy("createdAt", "desc").limit(50)
              .onSnapshot((snapshot) => {
                const currentSystemMessages = Array.from(messagesContainer.querySelectorAll('.system'));
                messagesContainer.innerHTML = '';
                currentSystemMessages.forEach(msg => messagesContainer.appendChild(msg));
                
                const messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                
                messages.reverse().forEach(message => {
                     const messageType = message.sender === username ? 'sent' : 'received';
                     if (message.sender.toLowerCase() === 'sistem') {
                         addMessage(message.sender, message.text, 'system');
                     } else {
                         addMessage(message.sender, message.text, messageType);
                     }
                });
            });
        }
        
        // Ekrana Mesaj Ekleme Fonksiyonu
        function addMessage(sender, text, type) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type);
            if (type !== 'system') {
                const usernameElement = document.createElement('div');
                usernameElement.classList.add('username');
                usernameElement.innerText = sender;
                messageElement.appendChild(usernameElement);
            }
            const textElement = document.createElement('div');
            textElement.innerText = text;
            messageElement.appendChild(textElement);
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    </script>
</body>
</html>
